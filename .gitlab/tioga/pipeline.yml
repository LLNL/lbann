################################################################################
## Copyright (c) 2014-2022, Lawrence Livermore National Security, LLC.
## Produced at the Lawrence Livermore National Laboratory.
## Written by the LBANN Research Team (B. Van Essen, et al.) listed in
## the CONTRIBUTORS file. <lbann-dev@llnl.gov>
##
## LLNL-CODE-697807.
## All rights reserved.
##
## This file is part of LBANN: Livermore Big Artificial Neural Network
## Toolkit. For details, see http://software.llnl.gov/LBANN or
## https://github.com/LLNL/LBANN.
##
## Licensed under the Apache License, Version 2.0 (the "Licensee"); you
## may not use this file except in compliance with the License.  You may
## obtain a copy of the License at:
##
## http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
## implied. See the License for the specific language governing
## permissions and limitations under the license.
################################################################################

# This is the testing pipeline for the Corona cluster at LLNL. This
# cluster builds the LBANN applications and libraries using a single
# compiler toolchain and then runs a collection of tests. Testing
# output is in JUnit format and parsed by the pipeline for web
# viewing.

# See the Catalyst pipeline for more thorough documentation.

stages:
  - allocate
  - build
  - test
  - deallocate

# Get LC resources.
allocate lc resources:
  stage: allocate
  extends: .tioga common
  variables:
    GIT_STRATEGY: none
  script:
    - echo "== ACQUIRING FLUX RESOURCES =="
    - echo "${WITH_WEEKLY:+Running with --weekly}"
    - export TEST_TIME=$([[ -n "${WITH_WEEKLY}" ]] && echo "120m" || echo "90m")
    - export LBANN_NNODES=$([[ -n "${WITH_WEEKLY}" ]] && echo "4" || echo "2")
    - export FLUX_F58_FORCE_ASCII=t
    - jobid=$(flux --parent alloc -N ${LBANN_NNODES} -g 1 -t ${TEST_TIME} --job-name=${JOB_NAME} --bg)
    - export JOB_ID=$jobid
  timeout: 6h

# Build LBANN and establish the Spack environment for this pipeline.
build and install:
  extends: .tioga common
  stage: build
  artifacts:
    paths:
      - spack-*.txt
      - spack-build-*/CMakeCache.txt
      - spack-build-*/build.ninja
      - spack-build-*/spack-*.txt
      - spack-ci-env-name.sh
      - LBANN_*.cmake
      - LBANN_*_setup_module_path.sh
#      - GITLAB_SUFFIX=`basename ${CI_BUILDS_DIR}`
#      - builds/*
      - builds/lbann_${SYSTEM_NAME}_${SPACK_ENV_BASE_NAME}-*${CI_CONCURRENT_ID}-*/*
#      - builds/${SYSTEM_NAME}_${SPACK_ENV_BASE_NAME}-${GITLAB_SUFFIX}-${SPACK_ARCH_TARGET}*
      - ${RESULTS_DIR}/*
  script:
    - echo "== BUILDING LBANN =="
    - echo "GLOBAL GITLAB SUFFIX = ${GITLAB_SUFFIX_GLOBAL}"
    - export FLUX_F58_FORCE_ASCII=t
    - "export JOB_ID=$(flux jobs -no {id}:{name} | grep ${JOB_NAME} | awk -F: '{print $1}')"
    - "export LBANN_NNODES=$(flux jobs -no {id}:{name}:{nnodes} | grep ${JOB_NAME} | awk -F: '{print $3}')"
    - export BUILD_TASKS=$(($(nproc) + 2))
    - echo "SPACK_REPO=${HOME}/${SPACK_REPO}"
#    - export GITLAB_SUFFIX=`basename ${CI_BUILDS_DIR}`
    - echo "BVE I think that the concurrent ID is ${CI_CONCURRENT_ID} and my GL suffix are ${GITLAB_SUFFIX} and the other concurrent project id is ${CI_CONCURRENT_PROJECT_ID} and Jobi id ${CI_BUILDS_DIR} SPACK_PADDED_CONCURRENT_ID is ${SPACK_PADDED_CONCURRENT_ID} len is ${CONCURRENT_ID_LEN} and trim is ${SPACK_PADDED_TRIM}"
#    - echo "GitLab CI/CD | Print all environment variables"
#    - env
#    - export SPACK_ENV_NAME=${SPACK_ENV_BASE_NAME}
    - export SPACK_ENV_NAME=${SPACK_ENV_BASE_NAME}-${GITLAB_SUFFIX}
    - source ${HOME}/${SPACK_REPO}/share/spack/setup-env.sh
    - flux proxy ${JOB_ID} flux mini run -N 1 -t 30m ./scripts/build_lbann.sh -r
      -l ${SPACK_ENV_NAME} -j ${BUILD_TASKS} --clean-build
      -p py-pip --ci-pip --
      +deterministic +vision +numpy +unit_tests ${SPACK_SPECS}
    - export TEST_TASKS_PER_NODE=4
    - export TEST_MPIBIND_FLAG="--mpibind=off"
    - export SPACK_ARCH=$(flux proxy ${JOB_ID} flux mini run -N 1 spack arch)
    - export SPACK_ARCH_TARGET=$(flux proxy ${JOB_ID} flux mini run -N 1 spack arch -t)
    - echo "source LBANN_${SYSTEM_NAME}_${SPACK_ENV_NAME}-${SPACK_ARCH_TARGET}_setup_lbann_modulepath.sh"
    - source LBANN_${SYSTEM_NAME}_${SPACK_ENV_NAME}-${SPACK_ARCH_TARGET}_setup_module_path.sh
    - echo "${LBANN_BUILD_LABEL}"
    - echo "${LBANN_BUILD_PARENT_DIR}"
    - echo "${LBANN_BUILD_DIR}"
    - echo "${LBANN_INSTALL_DIR}"
    - echo "${LBANN_MODFILES_DIR}"
#    - module load craype-x86-trento craype-network-ofi libfabric/1.7.2-llnl perftools-base/23.02.0 amd/5.4.3 craype/2.7.19 cray-libsci/23.02.1.1 PrgEnv-amd/8.3.3 cray-mpich/8.1.24 StdEnv cmake/3.24.2
    - export LD_LIBRARY_PATH=${CRAY_LD_LIBRARY_PATH}:${LD_LIBRARY_PATH}
    - export LD_LIBRARY_PATH=${ROCM_PATH}/lib:${LD_LIBRARY_PATH}
    - echo "${LBANN_MODFILES_DIR}"
#    - ml use ${LBANN_MODFILES_DIR}
    - ml load lbann
    - echo "$(which lbann)"
#    - export LD_LIBRARY_PATH=/usr/workspace/brain/tom/tioga/rocm-5.4.3/aws-ofi-rccl/lib:${LD_LIBRARY_PATH}
    - echo "export SPACK_DEP_ENV_NAME=${SPACK_ENV_NAME}" > spack-ci-env-name.sh
    - echo "export SPACK_ARCH=${SPACK_ARCH}" >> spack-ci-env-name.sh
    - echo "export SPACK_ARCH_TARGET=${SPACK_ARCH_TARGET}" >> spack-ci-env-name.sh
    - echo "export LBANN_BUILD_PARENT_DIR=${LBANN_BUILD_PARENT_DIR}" >> spack-ci-env-name.sh
    - echo "export LD_LIBRARY_PATH=/usr/workspace/brain/tom/tioga/rocm-5.4.3/aws-ofi-rccl/lib:${LD_LIBRARY_PATH}" >> spack-ci-env-name.sh
    - flux proxy ${JOB_ID} .gitlab/common/run-catch-tests-flux.sh

# Run the Python-based unit tests.
unit tests:
  extends:
    - .tioga common
    - .uses spack environment
  stage: test
  dependencies:
    - build and install
  script:
    - echo "== RUNNING PYTHON-BASED UNIT TESTS =="
    - echo "Testing $(which lbann)"
    - export FLUX_F58_FORCE_ASCII=t
    - export OMP_NUM_THREADS=10
    - "export FLUX_JOB_ID=$(flux jobs -no {id}:{name} | grep ${JOB_NAME} | awk -F: '{print $1}')"
    - cd ci_test/unit_tests
    - export LD_LIBRARY_PATH=${CRAY_LD_LIBRARY_PATH}:${LD_LIBRARY_PATH}
    - flux proxy ${FLUX_JOB_ID} lbann_pfe.sh -m pytest -s -vv --durations=0 --junitxml=results.xml
  artifacts:
    when: always
    paths:
      - ci_test/unit_tests/results.xml
    reports:
      junit: ci_test/unit_tests/results.xml

# Run the Python-based integration tests.
integration tests:
  extends:
    - .tioga common
    - .uses spack environment
  stage: test
  dependencies:
    - build and install
  script:
    - echo "== RUNNING PYTHON-BASED INTEGRATION TESTS =="
    - echo "Testing $(which lbann)"
    - export FLUX_F58_FORCE_ASCII=t
    - export OMP_NUM_THREADS=10
    - "export FLUX_JOB_ID=$(flux jobs -no {id}:{name} | grep ${JOB_NAME} | awk -F: '{print $1}')"
    - cd ci_test/integration_tests
    - export WEEKLY_FLAG=${WITH_WEEKLY:+--weekly}
    - export LD_LIBRARY_PATH=${CRAY_LD_LIBRARY_PATH}:${LD_LIBRARY_PATH}
    - flux proxy ${FLUX_JOB_ID} lbann_pfe.sh -m pytest -s -vv --durations=0 ${WEEKLY_FLAG} --junitxml=results.xml
  artifacts:
    when: always
    paths:
      - ci_test/integration_tests/results.xml
    reports:
      junit: ci_test/integration_tests/results.xml

# This is a dummy job that checks the Catch2 testing.
check catch2 tests:
  variables:
    GIT_STRATEGY: none
  extends:
    - .tioga common
  stage: test
  dependencies:
    - build and install
  script:
    - find ${RESULTS_DIR} -name "catch-tests-failed.txt" -print
    - find ${RESULTS_DIR} -name "catch-tests-failed.txt" -exec cat {} \;
    - ([[ $(find ${RESULTS_DIR} -name "catch-tests-failed.txt" | wc -l) -eq 0 ]])
  artifacts:
    reports:
      junit: ${RESULTS_DIR}/*.xml

# Cleanup the pipeline's Spack environment.
# Switching over to reusing Spack environments for each feature branch so don't remove them immediately
# Cleanup any build directories and spack environments older than 5 days since last use
remove spack environment:
  extends: .tioga common
  stage: deallocate
  variables:
    GIT_STRATEGY: none
  when: always
  script:
    - echo "== REMOVING OLD BUILD RESOURCES =="
    - source ${HOME}/${SPACK_REPO}/share/spack/setup-env.sh
    - find ${CI_PROJECT_DIR} -maxdepth 1 -mtime +5 -name "spack-build-*" -type d -exec rm -r {} \;
    - find ${HOME}/${SPACK_REPO}/var/spack/environments/ -maxdepth 1 -mtime +5 -type d -exec basename {} \; | xargs -r spack env rm --yes-to-all

# Free the allocation we obtained in "allocate lc resources".
release allocation:
  stage: deallocate
  extends: .tioga common
  variables:
    GIT_STRATEGY: none
  when: always
  script:
    - echo "== RELEASING RESOURCES =="
    - "export JOB_ID=$(flux jobs -no {id}:{name} | grep ${JOB_NAME} | awk -F: '{print $1}')"
    - ([[ -n "${JOB_ID}" ]] && flux job cancel ${JOB_ID})

# Load the spack shell integration and load the environment.
.uses spack environment:
  before_script:
    - source ${HOME}/${SPACK_REPO}/share/spack/setup-env.sh
    - source spack-ci-env-name.sh
#    - export GITLAB_SUFFIX=`basename ${CI_BUILDS_DIR}`
#    - export SPACK_ENV_NAME=${SPACK_ENV_BASE_NAME}-${GITLAB_SUFFIX}
    - echo "BVE starting the unit or integration tests"
    - ml
    - echo "source ${LBANN_BUILD_PARENT_DIR}/LBANN_${SYSTEM_NAME}_${SPACK_DEP_ENV_NAME}-${SPACK_ARCH_TARGET}_setup_module_path.sh"
    - source ${LBANN_BUILD_PARENT_DIR}/LBANN_${SYSTEM_NAME}_${SPACK_DEP_ENV_NAME}-${SPACK_ARCH_TARGET}_setup_module_path.sh
    - ml load lbann
    - ml
    - echo "$(which lbann)"
    # - spack env activate lbann-${SPACK_DEP_ENV_NAME}-${SPACK_ARCH_TARGET}
    # - spack load lbann@${SPACK_DEP_ENV_NAME}-${SPACK_ARCH_TARGET} arch=${SPACK_ARCH}
    - export FLUX_F58_FORCE_ASCII=t
#    - module load craype-x86-trento craype-network-ofi libfabric/1.7.2-llnl perftools-base/23.02.0 amd/5.4.3 craype/2.7.19 cray-libsci/23.02.1.1 PrgEnv-amd/8.3.3 cray-mpich/8.1.24 StdEnv cmake/3.24.2


# Variables for Tioga.
.tioga common:
  variables:
    # Just the obvious identifier. Which specific node doesn't matter.
    SYSTEM_NAME: tioga
    SPACK_REPO: spack_repos/spack_develop.git
#    SPACK_REPO: spack_repos/spack_${SYSTEM_NAME}.git

    # This is based on the assumption that each runner will only ever
    # be able to run one pipeline on a given cluster at one time.
    SPACK_ENV_BASE_NAME: gitlab-${CI_COMMIT_BRANCH}-${GITLAB_USER_LOGIN}-${SYSTEM_NAME}-${CI_RUNNER_SHORT_TOKEN}
    SPACK_PADDING: "000"
    CONCURRENT_ID_LEN: ${#CI_CONCURRENT_ID}
    SPACK_PADDED_TRIM: ${SPACK_PADDING:${CONCURRENT_ID_LEN}}
    SPACK_PADDED_CONCURRENT_ID: ${SPACK_PADDED_TRIM}${CI_CONCURRENT_ID}
#    SPACK_PADDED_CONCURRENT_ID: "${SPACK_PADDING:${#CI_CONCURRENT_ID}}${CI_CONCURRENT_ID}"
#    SPACK_PADDED_CONCURRENT_ID: "${SPACK_PADDING:${#CI_CONCURRENT_ID}:${#SPACK_PADDING}}${CI_CONCURRENT_ID}"
#    SPACK_ENV_BASE_NAME: gitlab-${CI_COMMIT_BRANCH}-${GITLAB_USER_LOGIN}-${SYSTEM_NAME}-${CI_RUNNER_SHORT_TOKEN}-${SPACK_PADDED_CONCURRENT_ID}

#    GITLAB_SUFFIX_GLOBAL: basename "${CI_BUILDS_DIR}"
    GITLAB_SUFFIX_GLOBAL: "${CI_BUILDS_DIR##*}"

    # These are system-specific specs that should be forwarded to the
    # build script
    SPACK_SPECS: "+rocm"

    # This variable is the name used to identify the job in the Slurm
    # queue. We need this to be able to access the correct jobid.
    JOB_NAME: ${CI_PROJECT_NAME}_${CI_PIPELINE_ID}

    # This is needed to ensure that we run as lbannusr.
    LLNL_SERVICE_USER: lbannusr

    # Catch2 output.
    RESULTS_DIR: results-${CI_PIPELINE_ID}

    # This needs to be imported here, too. Failure to do so causes
    # problems if it's not set.
    LBANN_CI_RUN_WEEKLY: ${LBANN_CI_RUN_WEEKLY}

    # Preserve any spack-build-* directories to allow for faster testing
    GIT_CLEAN_FLAGS: -ffdx -e spack-build-* -e builds/* -e LBANN_*.cmake -e LBANN_*_setup_module_path.sh -e LBANN_*_setup_build_tools.sh

  tags:
    - tioga
    - shell
